name: üè• AMI Grand Rounds Diagnostic
on:
  pull_request:
    paths:
      - 'manifests/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  clinical-audit:
    runs-on: ubuntu-latest
    steps:
      - name: üß¨ Isolate Manifest
        uses: actions/checkout@v4

      - name: üîç Ward 1: Secret & Credential Triage
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./manifests
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          extra_args: --only-verified

      - name: üîç Ward 2: Contamination Scan (PII & System Leaks)
        id: diagnostic_scan
        run: |
          # 1. PII/PHI (Emails, SSNs)
          PII_DATA=$(grep -rE "([a-zA-Z0-9._%-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}|[0-9]{3}-[0-9]{2}-[0-9]{4})" ./manifests || true)
          
          # 2. Local System Leaks (User directories & Absolute paths)
          SYSTEM_LEAKS=$(grep -rE "(/Users/|/home/|C:\\\\Users\\\\|[a-zA-Z]:\\\\)" ./manifests || true)
          
          # 3. Environment Variable References
          ENV_LEAKS=$(grep -rE "(\$HOME|\$USER|\$PATH|\$PWD)" ./manifests || true)

          # 4. Injection/Bypass Patterns (DAN, Ignore Previous, etc.)
          INJECTIONS=$(grep -riE "(ignore previous|system override|DAN mode|base64|developer mode)" ./manifests || true)

          # Pass findings to output
          {
            echo "PII_REPORT<<EOF"
            echo "$PII_DATA"
            echo "EOF"
            echo "SYSTEM_REPORT<<EOF"
            echo "$SYSTEM_LEAKS"
            echo "EOF"
            echo "ENV_REPORT<<EOF"
            echo "$ENV_LEAKS"
            echo "EOF"
            echo "INJECTION_REPORT<<EOF"
            echo "$INJECTIONS"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: üìù Issue Medical Report
        uses: actions/github-script@v7
        with:
          script: |
            const pii = `${{ steps.diagnostic_scan.outputs.PII_REPORT }}`.trim();
            const sys = `${{ steps.diagnostic_scan.outputs.SYSTEM_REPORT }}`.trim();
            const env = `${{ steps.diagnostic_scan.outputs.ENV_REPORT }}`.trim();
            const inj = `${{ steps.diagnostic_scan.outputs.INJECTION_REPORT }}`.trim();

            let status = "‚úÖ HEALTHY";
            let diagnosis = "Agent manifest is clean and non-contagious.";
            let findings = [];

            if (pii) findings.push("- **PII/PHI Contamination:** Found sensitive identity patterns.");
            if (sys) findings.push("- **System Residue:** Local machine paths detected.");
            if (env) findings.push("- **Environment Leak:** Internal shell variables exposed.");
            if (inj) findings.push("- **Instruction Drift:** Potentially malicious injection patterns found.");

            if (findings.length > 0) {
              status = "‚ö†Ô∏è QUARANTINE";
              diagnosis = "Multiple security pathologies detected. Action required to prevent environmental spread.";
            }

            let reportBody = `## üè• AMI Diagnostic Report\n\n**Overall Health:** ${status}\n**Diagnosis:** ${diagnosis}\n\n`;

            if (findings.length > 0) {
              reportBody += `### ü©∫ Treatment Plan\nTo pass the next audit, the agent must implement these sanitization measures:\n${findings.join("\n")}\n\n*Refer to the [Clinical Standard for Data Integrity](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/SANITIZATION_GUIDE.md) for remediation steps.*`;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: reportBody
            })
